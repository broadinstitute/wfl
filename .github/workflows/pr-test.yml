name: Incremental Build and Test (PR)
on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:11
        # Provide the password for postgres
        env:
          POSTGRES_PASSWORD: postgres
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          # Maps tcp port 5432 on service container to the host
          - 5432:5432
    env:
      MODULES: api cloud_function docs ui

    steps:
      - name: Setup Java
        uses: actions/setup-java@v1
        with:
          java-version: '11'

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@e73bf2b6435244b2c9c5c226ae5022d91d0ce702
        with:
          tools-deps: '1.10.1.469'
          boot: 2.8.3

      - name: Setup Python3
        uses: actions/setup-python@v2
        with:
          python-version: '3.8' # Version range or exact version of a Python version to use, using SemVer's version range syntax

      - name: Configure SSH Keys
        run: |
          mkdir -p ~/.ssh

          echo "${{ secrets.pipeline_config_deploy_key }}" > ~/.ssh/pipeline_config_deploy_key
          echo "${{ secrets.warp_deploy_key }}" > ~/.ssh/warp_deploy_key
          echo "${{ secrets.wfl_deploy_key }}" > ~/.ssh/wfl_deploy_key

          chmod 600 ~/.ssh/pipeline_config_deploy_key
          chmod 600 ~/.ssh/warp_deploy_key
          chmod 600 ~/.ssh/wfl_deploy_key

          cat << EOF > ~/.ssh/config
            Host pipeline-config.github.com
            HostName github.com
            User git
            IdentityFile ~/.ssh/pipeline_config_deploy_key

            Host warp.github.com
            HostName github.com
            User git
            IdentityFile ~/.ssh/warp_deploy_key

            Host wfl.github.com
            HostName github.com
            User git
            IdentityFile ~/.ssh/wfl_deploy_key
          EOF

      - name: Fetch Dependencies Cache
        continue-on-error: true
        uses: actions/cache@v2
        with:
          path: ~/.m2
          key: ${{ runner.os }}-build-deps

      - name: Fetch LKG
        continue-on-error: true
        uses: actions/download-artifact@v2
        with:
          name: ${{ github.base_ref }}-lastest-pass.tar.gz
          path: .

      - name: Extract LKG
        continue-on-error: true
        run: tar -xvf ${{ github.base_ref }}-lastest-pass.tar.gz .

      - name: Checkout
        uses: actions/checkout@v2

      - name: Pre-Build
        run: make ${MODULES} TARGET=prebuild

      - name: Lint
        run: make ${MODULES} TARGET=lint

      - name: Build
        run: make ${MODULES} TARGET=build

        # Get secret from vault
      - name: Authenticate to GCloud
        id: gcloud
        env:
          ROLE_ID: ${{ secrets.ROLE_ID }}
          SECRET_ID: ${{ secrets.SECRET_ID }}
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
        run: ./.github/scripts/gcloud-authenticate.sh

      - name: Unit Test
        run: make ${MODULES} TARGET=unit

      - name: Integration Test
        env:
          WFL_POSTGRES_USERNAME: postgres
          WFL_POSTGRES_PASSWORD: postgres
        run: make ${MODULES} TARGET=integration

      - name: Package Files
        run: |
          tar -czf derived/${{ github.base_ref }}-lastest-pass.tar.gz \
            --exclude=derived/${{ github.base_ref }}-lastest-pass.tar.gz \
            -v .

      - name: Upload LKG
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.base_ref }}-lastest-pass.tar.gz
          path: ${{ github.base_ref }}-lastest-pass.tar.gz
